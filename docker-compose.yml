# Docker Compose: define serviços, redes e volumes para este projeto
# Versão é omitida (Compose V2 usa a versão por padrão) — mantemos a sintaxe compatível com Compose V2/V3

services:
  # Serviço de banco de dados Postgres
  db:
    # Imagem oficial do Postgres (versão 14). Se não existir localmente, o Docker fará o pull.
    image: postgres:14
    # Política de reinício: reinicia o container a menos que ele seja parado manualmente
    restart: unless-stopped
    # Variáveis de ambiente usadas pelo entrypoint do Postgres para criar DB/usuário iniciais
    environment:
      POSTGRES_USER: encurtador_user
      POSTGRES_PASSWORD: senha_super_segura_123
      POSTGRES_DB: encurtador_db
    # Volumes:
    # - db-data: volume nomeado que persiste os dados do Postgres entre recriações de container
    # - init.sql: script de inicialização (copiado para /docker-entrypoint-initdb.d) executado apenas
    #   na primeira inicialização quando o volume de dados estiver vazio
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    # Conecta o DB à rede interna do compose para permitir comunicação com outros serviços
    networks:
      - encnet

  # Serviço da aplicação Node.js
  app:
    # Em vez de usar uma imagem pronta, construímos a partir do Dockerfile no contexto do repo
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    # Garante que o container do DB seja iniciado antes do app.
    depends_on:
      - db
    # Variáveis de ambiente passadas para a aplicação (disponíveis em process.env)
    environment:
      DB_USER: encurtador_user    # usuário do Postgres
      DB_PASSWORD: senha_super_segura_123
      DB_HOST: db                # aponta para o serviço `db` na mesma rede
      DB_DATABASE: encurtador_db
      DB_PORT: 5432
      BASE_URL: http://localhost # base pública (usada ao montar as URLs curtas)
      PORT: 3000                 # porta que a aplicação escuta internamente no container
    # NÃO mapeamos portas para o host aqui — o app só será acessível via `proxy` na rede interna
    networks:
      - encnet

  # Serviço proxy (NGINX) — expõe a aplicação para o host na porta 80
  proxy:
    image: nginx:stable-alpine
    restart: unless-stopped
    # Mapeia a porta 80 do host para a porta 80 do container nginx
    ports:
      - "80:80"
    # Monta o arquivo de configuração do nginx (reverse proxy)
    volumes:
      - ./proxy/default.conf:/etc/nginx/conf.d/default.conf:ro
    # O proxy depende do app (ordem de start). Ele encaminha requisições para `app:3000` internamente.
    depends_on:
      - app
    networks:
      - encnet

# Volumes nomeados usados pelo Compose
volumes:
  db-data:

# Redes criadas pelo Compose. Aqui usamos uma bridge isolada chamada `encnet`.
networks:
  encnet:
    driver: bridge
